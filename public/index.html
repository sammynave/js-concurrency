<!doctype html>
<html class="no-js" lang="">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title></title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>

  <body>
    <script src="js-concurrency.iife.js"></script>

    <div id="ex-1">
      <h3>random numbers</h3>
      <div id="pick-random-numbers-count"></div>
      <button id="pick-random-numbers">pick random numbers</button> random number: <span id="random-numbers"></span>
    </div>
    <script>
      (function () {
        // From ember-concurrency.com
        const count = document.getElementById('pick-random-numbers-count');
        const button = document.getElementById('pick-random-numbers');
        const numbers = document.getElementById('random-numbers');
        const ex = jsc.task(function *() {
          let nums = [];

          for (let i = 0; i < 3; i++) {
            nums.push(Math.floor(Math.random() * 10));
          }

          numbers.textContent = nums.join(', ');
        });

        count.textContent = ex.performCount;
        button.addEventListener('click', function() {
          ex.perform();
          count.textContent = ex.performCount;
        });
      })();
    </script>

    <h2 style="border-bottom: 8px solid black;"></h2>

    <div id="ex-2">
      <h3>using `yield` - fetch random name from faker.io</h3>
      <div>
        <div>count: <span id="fetch-name-count"></span></div>
        <div>task instance status: <span id="random-name-status"></span></div>
        <div>task status: <span id="task-state"></span></div>
        <button id="fetch-name">random name</button> fetch random name: <span id="random-name"></span>
      </div>

      <h2 style="border-bottom: 2px solid black;"></h2>

      <div>
        <div>task instance status: <span id="err-random-name-status"></span></div>
        <div>task status: <span id="err-task-state"></span></div>
        <div>count: <span id="err-fetch-name-count"></span></div>
        <button id="err-fetch-name">throw error</button> fetch random name: <span id="err-random-name"></span>
      </div>
    </div>
    <script>
      (function () {
        const count = document.getElementById('fetch-name-count');
        const button = document.getElementById('fetch-name');
        const errButton = document.getElementById('err-fetch-name');
        const nameEl = document.getElementById('random-name');
        const errNameEl = document.getElementById('err-random-name');
        const errCount = document.getElementById('err-fetch-name-count');
        const statusEl = document.getElementById('random-name-status');
        const errStatusEl = document.getElementById('err-random-name-status');
        const taskStateEl = document.getElementById('task-state');
        const errTaskStateEl = document.getElementById('err-task-state');
        const ex = jsc.task(function *() {
          const resp = yield fetch('http://faker.hook.io/?property=name.findName&locale=en');
          const name = yield resp.text();

          nameEl.textContent = name;
        });

        button.addEventListener('click', function() {
          const task = ex.perform();

          count.textContent = ex.performCount;
          const exUnsubscribe = ex.subscribe((changed, { state }) => {
            if (changed.state) {
              taskStateEl.textContent = state;
            }
          });
          const unsubscribe = task.subscribe((changed, { state, value }) => {
            /*
             * TODO: slightly annoying to push this onto
             * the user. think of a better way
             */

            if (changed.state) {
              statusEl.textContent = state;
            }

            if (changed.value) {
              console.log(value);
            }
          });
        });

        /*
         * Error example
         */
        const errEx = jsc.task(function *() {
          try {
            const resp = yield fetch('http://somebadurlthatdoesntexist');
            const name = yield resp.text();

            errNameEl.textContent = name;
          } catch (e) {
            errNameEl.textContent = e.error;
          }
        });

        errButton.addEventListener('click', function() {
          const task = errEx.perform();
          errCount.textContent = errEx.performCount;
          const exUnsubscribe = errEx.subscribe((changed, { state }) => {
            if (changed.state) {
              errTaskStateEl.textContent = state;
            }
          });
          const unsubscribe = task.subscribe((changed, { state, value, error }) => {
            if (changed.state) {
              errStatusEl.textContent = state;
            }

            if (changed.value) {
              console.log(value);
            }

            if (changed.error) {
              console.error(`caught error from task and here it is: ${error}`);
            }
          });
        });

      })();
    </script>

    <h2 style="border-bottom: 8px solid black;"></h2>

    <div id="ex-3">
      <h3>drop</h3>
      <div>completed count: <span id="drop-run-count"></span></div>
      <div>dropped count: <span id="drop-count"></span></div>
      <button id="drop-random-numbers-button">pick random numbers</button> random number: <span id="drop-random-numbers"></span>
    </div>
    <script>
      (function () {
        const count = document.getElementById('drop-run-count');
        const droppedCount = document.getElementById('drop-count');
        const button = document.getElementById('drop-random-numbers-button');
        const numbers = document.getElementById('drop-random-numbers');
        const ex = jsc.task(function *() {
          let nums = [];

          for (let i = 0; i < 3; i++) {
            nums.push(Math.floor(Math.random() * 10));
          }

          // Fake waiting
          yield new Promise((resolve) => {
            setTimeout(resolve, 1000);
          });

          numbers.textContent = nums.join(', ');
        }, { drop: true, maxConcurrency: 1 });

        count.textContent = ex.performCount;
        droppedCount.textContent = ex.droppedCount;

        button.addEventListener('click', function() {
          const task = ex.perform();
          droppedCount.textContent = ex.droppedCount;
          count.textContent = ex.performCount;
        });
      })();
    </script>

  </body>
</html>
